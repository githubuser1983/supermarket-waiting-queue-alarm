<html>

<head>
    <link rel="stylesheet" href="https://bootswatch.com/4/slate/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* Bootstrap 4 text input with search icon */

        .has-search .form-control {
            padding-left: 2.375rem;
        }

        .has-search .form-control-feedback {
            position: absolute;
            z-index: 2;
            display: block;
            width: 2.375rem;
            height: 2.375rem;
            line-height: 2.375rem;
            text-align: center;
            pointer-events: none;
            color: #aaa;
        }

        .data-container{
            background-color: #272B30;
            padding: 0px;
        }
        .data-element{
            margin-top: 0.2em;
        }
    </style>

</head>

<body>
    <div class="container">
        <form id="filterform" method="post" class="form-horizontal" action="">
            <div class="mx-auto" style="max-width: 36rem; margin-top: 20px;">
                <div class="form-group">
                    <label for="plz">PLZ:</label>
                    <input type="text" class="form-control" id="plz" name="plz" placeholder="Example: 97990"
                        pattern="[0-9]{5}">
                </div>
            </div>

            <div id="results" class="card mx-auto" style="max-width: 36rem; display: none;">
                <div class="card-header">
                    <div class="form-group has-search">
                        <span class="fa fa-search form-control-feedback"></span>
                        <input type="text" class="form-control" placeholder="Search" id="search" name="search" disabled>
                    </div>
                </div>
                <div id="data-container" class="card-body data-container">
                    Featured
                </div>
            </div>

        </form>
    </div>


    <script>
        var page = -1;
        var end = false;
        var elementCount = 0;


        $(plz).on('input', function () {
            onPlzChange();
        });

        $.validator.setDefaults({
            submitHandler: function () {
                alert("submitted!");
            }
        });

        $(document).ready(function () {
            $("#filterform").validate({
                rules: {
                    plz: {
                        required: true,
                        number: true,
                        maxlength: 5,
                        minlength: 5
                    }
                },
                messages: {
                    plz: {
                        required: "Bitte geben Sie eine gültige Postleitzahl ein",
                        minlength: "Eine Postleizahl muss aus 5 Zahlen bestehen",
                        maxlength: "Eine Postleizahl muss aus 5 Zahlen bestehen",
                        number: "Bitte geben Sie eine gültige Postleitzahl ein"
                    }
                },
                errorElement: "em",
                errorPlacement: function (error, element) {
                    // Add the `help-block` class to the error element
                    error.addClass("help-block");

                    // Add `has-feedback` class to the parent div.form-group
                    // in order to add icons to inputs
                    element.parents(".col-sm-5").addClass("has-feedback");

                    if (element.prop("type") === "checkbox") {
                        error.insertAfter(element.parent("label"));
                    } else {
                        error.insertAfter(element);
                    }

                    // Add the span element, if doesn't exists, and apply the icon classes to it.
                    if (!element.next("span")[0]) {
                        $("<span class='glyphicon glyphicon-remove form-control-feedback'></span>").insertAfter(element);
                    }
                },
                success: function (label, element) {
                    // Add the span element, if doesn't exists, and apply the icon classes to it.
                    if (!$(element).next("span")[0]) {
                        $("<span class='glyphicon glyphicon-ok form-control-feedback'></span>").insertAfter($(element));
                    }
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).parents(".col-sm-5").addClass("has-error").removeClass("has-success");
                    $(element).next("span").addClass("glyphicon-remove").removeClass("glyphicon-ok");
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).parents(".col-sm-5").addClass("has-success").removeClass("has-error");
                    $(element).next("span").addClass("glyphicon-ok").removeClass("glyphicon-remove");
                }
            });
        });


        function onPlzChange() {
            elementCount = 0
            end = false;
            if ($("#filterform").valid()) {
                loadDataInit();
                $("#results").show();
                loadData()
            } else {
                $("#results").hide();
            }
        }

        function loadDataInit() {
            page = 0;
            $("#data-container").html("Daten werden geladen...");

        }

        function loadData() {
            page = 0;
            addDataToDataContainer(mockData(), false)

        }


        function addDataToDataContainer(data, append) {
            if(data.length == 0){
                end = true;
                $("#data-container").append(`${elementCount}/${elementCount} Einträgen`);
            }
            var html = ""
            for (index = 0; index < data.length; index++) {
                html += `<div class="card data-element"><div class=\"card-body\">`
                html += `<p>${data[index].name}<br/>`
                html += `${data[index].adress}<br/>`
                html += `Anzahl Warnung 1h:${data[index].waiting_queue_last_hour}<br/>`
                html += `Anzahl Warnung 24h:${data[index].waiting_queue_last_24_hour}<br/></p>`
                html += `<button type="button" class="btn btn-warning">Warteschlange melden</button>`
                html += `</div></div>`
            }
            if (append) {
                $("#data-container").html($("#data-container").html().replace("Daten werden geladen...",""));
                $("#data-container").append(html);
                elementCount = elementCount+data.length;

            }
            else {
                $("#data-container").html(html);
                elementCount = data.length;
            }

        }


        function mockData() {
            if(page == 5){
                return [];
            }

            return [{
                "id": 1,
                "name": `Rewe1 ${page}`,
                "adress": "Musterstr.6 90441 Nürnberg",
                "waiting_queue_last_hour": 33,
                "waiting_queue_last_24_hour": 33
            }, {
                "id": 2,
                "name": "Rewe2",
                "adress": "Musterstr.6 90441 Nürnberg",
                "waiting_queue_last_hour": 33,
                "waiting_queue_last_24_hour": 33
            }, {
                "id": 3,
                "name": "Rewe3",
                "adress": "Musterstr.6 90441 Nürnberg",
                "waiting_queue_last_hour": 33,
                "waiting_queue_last_24_hour": 33
            }, {
                "id": 4,
                "name": "Rewe4",
                "adress": "Musterstr.6 90441 Nürnberg",
                "waiting_queue_last_hour": 33,
                "waiting_queue_last_24_hour": 33
            }, {
                "id": 5,
                "name": "Rewe5",
                "adress": "Musterstr.6 90441 Nürnberg",
                "waiting_queue_last_hour": 33,
                "waiting_queue_last_24_hour": 33
            }];
        }

        $(window).scroll(function () {
            if(end){
                return;
            }
            // End of the document reached?
            if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10){
                $("#data-container").append("Daten werden geladen...");
                page = page +1 ;
                addDataToDataContainer(mockData(), true)
            }
        });



    </script>
</body>


</html>